# ################################################################################
# purpose: Run tasks in postgres
# status: WORKING
#
docker stop c-python
docker rm c-python
docker rmi i-python
#
# build
docker build -t i-python .
#
# run
docker run -d --name c-python --network n-raogaru -v ./scripts:/app/scripts i-python tail -f /dev/null
#
docker stop c-python
docker start c-python
#
# connect
docker exec -it c-python /bin/sh
#
# --------------------------------------------------------------------------------
# test
docker exec -it c-python /bin/sh

#
# create ddl scripts - for the purpose of running tasks on postgres. 
vLINE="################################################################################"

# repat for job1 to job5
for DIRNAME in job1 job2 job3 job4 job5 part_list part_hash part_range part_random
do
echo ${vLINE}
#vi jobs/job1/tabgen.yaml
docker exec -it c-python tabgen.py scripts/${DIRNAME}/tabgen.yaml
done

# In postgres create schemas job0...job5 part_list part_hash part_range part_random
docker exec -it c-postgres /bin/sh
su - postgres
\i postgres.sql

# execute jobs - which will create tables in postgres
for DIRNAME in sample job1 job2 job3 job4 job5 part_list part_hash part_range part_random
do
echo ${vLINE}
docker exec -it c-python jobrun.py scripts/${DIRNAME}/jobrun.yaml
docker exec -it c-python jobrun.py scripts/${DIRNAME}/cleanup.yaml
done


# sql query to check number of tables by schema
SELECT
    n.nspname AS schema_name,
    COUNT(*)  AS table_count
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE c.relkind IN ('r', 'p')              -- regular + partitioned tables
  AND n.nspname NOT IN ('pg_catalog', 'information_schema')
GROUP BY n.nspname
ORDER BY n.nspname;


select count(1) from public.rdb_jobrun_log;


# ################################################################################
